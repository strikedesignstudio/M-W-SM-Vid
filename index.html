<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Responsive Water Distortion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/spite/ccapture.js/build/CCapture.all.min.js"></script>
    <style>
        body { margin: 0; display: flex; justify-content: center; align-items: center; }
        canvas { border: 1px solid black; display: block; }
    </style>
</head>
<body>
    <script>
        let img;
        let pixelSize = 8; // Control the pixelation level
        let capturer;
        let duration = 60; // Video duration in seconds
        let fps = 300;
        let recording = false;
        let aspectRatio;

        function preload() {
            img = loadImage("your-image.png"); // Replace with your image file
        }

        function setup() {
            aspectRatio = img.width / img.height;
            resizeCanvasToFit();
            
            // Set up video capture
            capturer = new CCapture({
                format: 'webm',
                framerate: fps,
                verbose: true
            });

            frameRate(fps);
            recording = true;
            capturer.start();
        }

        function draw() {
            background(0, 0); // Transparent background
            let imgWidth = height * aspectRatio;
            let imgHeight = height;

            // Center the image within the canvas
            let offsetX = (width - imgWidth) / 2;
            let offsetY = (height - imgHeight) / 2;

            img.loadPixels();
            let time = millis() * 0.0005;

            for (let y = 0; y < imgHeight; y += pixelSize) {
                for (let x = 0; x < imgWidth; x += pixelSize) {
                    let ix = int((x / imgWidth) * img.width);
                    let iy = int((y / imgHeight) * img.height);
                    let index = (ix + iy * img.width) * 4;

                    let r = img.pixels[index];
                    let g = img.pixels[index + 1];
                    let b = img.pixels[index + 2];
                    let a = img.pixels[index + 3];

                    // Apply noise-based offset for water ripple effect
                    let noiseOffsetX = int(noise(x * 0.05, y * 0.05, time) * pixelSize) - pixelSize / 2;
                    let noiseOffsetY = int(noise(y * 0.05, x * 0.05, time) * pixelSize) - pixelSize / 2;

                    fill(r, g, b, a);
                    noStroke();
                    rect(offsetX + x + noiseOffsetX, offsetY + y + noiseOffsetY, pixelSize, pixelSize);
                }
            }

            // Capture each frame if recording
            if (recording) {
                capturer.capture(canvas);
                if (frameCount >= duration * fps) {
                    capturer.stop();
                    capturer.save();
                    noLoop();
                    recording = false;
                }
            }
        }

        function windowResized() {
            resizeCanvasToFit();
        }

        function resizeCanvasToFit() {
            let canvasHeight = windowHeight;
            let canvasWidth = min(windowWidth, canvasHeight * aspectRatio);
            resizeCanvas(canvasWidth, canvasHeight);
        }
    </script>
</body>
</html>
